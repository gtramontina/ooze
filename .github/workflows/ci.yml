name: "ğŸ§© Continuous Integration"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:

  CI:
    strategy:
      matrix:
        runs-on:
          - "ubuntu-latest"
          - "windows-latest"
        go-version:
          - "1.22"
          - "latest"

    runs-on: ${{ matrix.runs-on }}
    continue-on-error: false

    steps:
      - uses: actions/checkout@v4

      # Ubuntu -----------------------------------------------------------------

      - if: ${{ matrix.runs-on == 'ubuntu-latest' }}
        name: "ğŸ§ - Install Devbox"
        uses: jetify-com/devbox-install-action@v0.11.0

      - if: ${{ matrix.runs-on == 'ubuntu-latest' }}
        name: "ğŸ§ - Set up Go ${{ matrix.go-version }}"
        run: devbox add go@${{ matrix.go-version }}

      - if: ${{ matrix.runs-on == 'ubuntu-latest' }}
        name: "ğŸ§ - ğŸ§¹ Lint"
        run: devbox run -- make lint

      - if: ${{ matrix.runs-on == 'ubuntu-latest' }}
        name: "ğŸ§ - ğŸ§ª Test"
        run: devbox run -- make test

      # Windows ----------------------------------------------------------------

      - if: ${{ matrix.runs-on == 'windows-latest' }}
        name: "ğŸªŸ - Set up Go ${{ matrix.go-version }}"
        uses: actions/setup-go@v5
        with:
          check-latest: ${{ matrix.go-version == 'latest' }}
          go-version: ${{ matrix.go-version != 'latest' && matrix.go-version || null }}

      - if: ${{ matrix.runs-on == 'windows-latest' }}
        name: "ğŸªŸ - ğŸ§¹ Lint"
        run: |
          choco install golangci-lint --version=1.61.0 -y
          golangci-lint -v --timeout 5m run

      - if: ${{ matrix.runs-on == 'windows-latest' }}
        name: "ğŸªŸ - ğŸ§ª Test"
        run: go test ./...
